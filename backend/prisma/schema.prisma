generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String             @id @default(cuid())
  authUserId          String?            @unique @map("auth_user_id")
  email               String             @unique
  businessName        String             @map("business_name")
  vendorType          String             @map("vendor_type")
  location            String?
  about               String?
  onboardingCompleted Boolean            @default(false) @map("onboarding_completed")
  balance             Decimal            @default(0.00) @db.Decimal(10, 2)
  isAdmin             Boolean            @default(false) @map("is_admin")
  adminVerifiedAt     DateTime?          @map("admin_verified_at")
  isBlocked           Boolean            @default(false) @map("is_blocked")
  blockedAt           DateTime?          @map("blocked_at")
  blockedReason       String?            @map("blocked_reason")
  billingFirstName    String?            @map("billing_first_name")
  billingLastName     String?            @map("billing_last_name")
  billingCompanyName  String?            @map("billing_company_name")
  billingIsCompany    Boolean            @default(false) @map("billing_is_company")
  billingAddressLine1 String?            @map("billing_address_line1")
  billingAddressLine2 String?            @map("billing_address_line2")
  billingCity         String?            @map("billing_city")
  billingState        String?            @map("billing_state")
  billingZip          String?            @map("billing_zip")
  billingCountry      String?            @default("United States") @map("billing_country")
  emailConfirmed      Boolean            @default(false) @map("email_confirmed")
  confirmationToken   String?            @unique @map("confirmation_token")
  confirmationSentAt  DateTime?          @map("confirmation_sent_at")
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")
  paymentMethods      PaymentMethod[]
  purchases           Purchase[]
  transactions        Transaction[]
  favorites           UserLeadFavorite[]
  leadFeedback        LeadFeedback[]

  @@map("users")
}

model Lead {
  id                 String             @id
  pipedriveDealId    Int?               @unique @map("pipedrive_deal_id")
  weddingDate        DateTime?          @map("wedding_date")
  city               String?
  state              String?
  location           String?
  description        String?
  ethnicReligious    String?            @map("ethnic_religious")
  firstName          String?            @map("first_name")
  lastName           String?            @map("last_name")
  personName         String?            @map("person_name")
  email              String?
  phone              String?
  source             String?
  gclid              String?
  fbclid             String?
  utmTerm            String?            @map("utm_term")
  spUtmCampaign      String?            @map("sp_utm_campaign")
  utmContent         String?            @map("utm_content")
  utmMedium          String?            @map("utm_medium")
  eventId            String?            @map("event_id")
  sessionId          String?            @map("session_id")
  pixelId            String?            @map("pixel_id")
  projectId          String?            @map("project_id")
  conversionPageUrl  String?            @map("conversion_page_url")
  expectedValue      Decimal?           @map("expected_value") @db.Decimal(10, 2)
  active             Boolean            @default(true)
  comment            String?
  budgetMin          Decimal?           @map("budget_min") @db.Decimal(10, 2)
  budgetMax          Decimal?           @map("budget_max") @db.Decimal(10, 2)
  servicesNeeded     String[]           @map("services_needed")
  price              Decimal            @default(20.00) @db.Decimal(10, 2)
  status             LeadStatus         @default(AVAILABLE)
  tags               String[]           @default([])
  lastClientResponse DateTime?          @map("last_client_response")
  maskedInfo         Json?              @map("masked_info")
  fullInfo           Json?              @map("full_info")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  purchases          Purchase[]
  favoritedBy        UserLeadFavorite[]
  feedback           LeadFeedback[]

  @@index([status])
  @@index([weddingDate])
  @@index([location])
  @@index([state])
  @@index([active])
  @@index([pipedriveDealId])
  @@map("leads")
}

model Transaction {
  id              String          @id @default(cuid())
  userId          String          @map("user_id")
  amount          Decimal         @db.Decimal(10, 2)
  type            TransactionType
  description     String?
  stripePaymentId String?         @map("stripe_payment_id")
  balanceAfter    Decimal         @map("balance_after") @db.Decimal(10, 2)
  metadata        Json?
  createdAt       DateTime        @default(now()) @map("created_at")
  user            User            @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("transactions")
}

model Purchase {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  leadId      String   @map("lead_id")
  amountPaid  Decimal  @map("amount_paid") @db.Decimal(10, 2)
  purchasedAt DateTime @default(now()) @map("purchased_at")
  notes       String?
  lead        Lead     @relation(fields: [leadId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@unique([userId, leadId])
  @@index([userId])
  @@index([leadId])
  @@map("purchases")
}

model PaymentMethod {
  id                    String   @id @default(cuid())
  userId                String   @map("user_id")
  stripePaymentMethodId String   @unique @map("stripe_payment_method_id")
  last4                 String
  brand                 String
  expiryMonth           Int      @map("expiry_month")
  expiryYear            Int      @map("expiry_year")
  isDefault             Boolean  @default(false) @map("is_default")
  createdAt             DateTime @default(now()) @map("created_at")
  user                  User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("payment_methods")
}

model AdminVerification {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  verifiedAt DateTime @default(now()) @map("verified_at")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")

  @@index([userId])
  @@map("admin_verifications")
}

model UserLeadFavorite {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  leadId    String   @map("lead_id")
  createdAt DateTime @default(now()) @map("created_at")
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, leadId])
  @@index([userId])
  @@index([leadId])
  @@map("user_lead_favorites")
}

model LeadFeedback {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  leadId         String   @map("lead_id")
  booked         Boolean
  leadResponsive String   @map("lead_responsive")
  timeToBook     String?  @map("time_to_book")
  amountCharged  Decimal? @map("amount_charged") @db.Decimal(10, 2)
  createdAt      DateTime @default(now()) @map("created_at")
  lead           Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, leadId])
  @@index([userId])
  @@index([leadId])
  @@index([booked])
  @@map("lead_feedback")
}

model AdminAuditLog {
  id           String   @id @default(cuid())
  adminUserId  String   @map("admin_user_id")
  action       String
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id")
  metadata     Json?
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([adminUserId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

model CrmBetaSignup {
  id             String   @id @default(cuid())
  name           String
  email          String   @unique
  phone          String
  companyName    String   @map("company_name")
  companyWebsite String?  @map("company_website")
  vendorType     String?  @map("vendor_type")
  message        String?
  status         String   @default("pending")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("crm_beta_signups")
}

enum LeadStatus {
  AVAILABLE
  SOLD
  EXPIRED
  HIDDEN
  REMOVED
}

enum TransactionType {
  DEPOSIT
  PURCHASE
  REFUND
  ADJUSTMENT
  FEEDBACK_REWARD
}
